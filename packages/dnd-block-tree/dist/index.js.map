{"version":3,"sources":["../src/core/types.ts","../src/core/collision.ts","../src/core/sensors.ts","../src/utils/helper.ts","../src/components/DropZone.tsx","../src/components/TreeRenderer.tsx","../src/components/DragOverlay.tsx","../src/utils/blocks.ts","../src/components/BlockTree.tsx","../src/hooks/useBlockState.tsx","../src/hooks/useTreeState.tsx"],"names":["useSensors","useSensor","PointerSensor","TouchSensor","KeyboardSensor","useDroppable","useCallback","useEffect","jsx","memo","useDraggable","Fragment","jsxs","DndKitDragOverlay","useRef","useReducer","DndContext","createContext","useContext","state","useState","useMemo","children"],"mappings":"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","file":"index.js","sourcesContent":["import type { ReactNode } from 'react'\nimport type { UniqueIdentifier } from '@dnd-kit/core'\n\n/**\n * Base block interface - extend this for your custom block types\n */\nexport interface BaseBlock {\n  id: string\n  type: string\n  parentId: string | null\n  order: number\n}\n\n/**\n * Normalized index structure for efficient tree operations\n */\nexport interface BlockIndex<T extends BaseBlock = BaseBlock> {\n  byId: Map<string, T>\n  byParent: Map<string | null, string[]>\n}\n\n/**\n * Props passed to non-container block renderers\n */\nexport interface BlockRendererProps<T extends BaseBlock = BaseBlock> {\n  block: T\n  children?: ReactNode\n  isDragging?: boolean\n  isOver?: boolean\n  depth: number\n}\n\n/**\n * Props passed to container block renderers (blocks that can have children)\n */\nexport interface ContainerRendererProps<T extends BaseBlock = BaseBlock>\n  extends BlockRendererProps<T> {\n  children: ReactNode\n  isExpanded: boolean\n  onToggleExpand: () => void\n}\n\n/**\n * Get the appropriate props type for a renderer based on whether it's a container type\n *\n * @example\n * type SectionProps = RendererPropsFor<MyBlock, 'section', typeof CONTAINER_TYPES>\n * // If CONTAINER_TYPES includes 'section', this is ContainerRendererProps\n * // Otherwise, it's BlockRendererProps\n */\nexport type RendererPropsFor<\n  T extends BaseBlock,\n  K extends T['type'],\n  C extends readonly string[]\n> = K extends C[number]\n  ? ContainerRendererProps<T & { type: K }>\n  : BlockRendererProps<T & { type: K }>\n\n/**\n * Map of block types to their renderers with automatic container detection\n *\n * @example\n * const CONTAINER_TYPES = ['section'] as const\n *\n * const renderers: BlockRenderers<MyBlock, typeof CONTAINER_TYPES> = {\n *   section: (props) => <Section {...props} />,  // props includes isExpanded, onToggleExpand\n *   task: (props) => <Task {...props} />,        // props is BlockRendererProps\n * }\n */\nexport type BlockRenderers<\n  T extends BaseBlock = BaseBlock,\n  C extends readonly string[] = readonly string[]\n> = {\n  [K in T['type']]: (props: RendererPropsFor<T, K, C>) => ReactNode\n}\n\n/**\n * Internal renderer type used by TreeRenderer (less strict for flexibility)\n */\nexport type InternalRenderers<T extends BaseBlock = BaseBlock> = {\n  [K in T['type']]: (props: BlockRendererProps<T> | ContainerRendererProps<T>) => ReactNode\n}\n\n/**\n * Block action types for the reducer\n */\nexport type BlockAction<T extends BaseBlock> =\n  | { type: 'ADD_ITEM'; payload: T }\n  | { type: 'DELETE_ITEM'; payload: { id: string } }\n  | { type: 'SET_ALL'; payload: T[] }\n  | { type: 'MOVE_ITEM'; payload: { activeId: UniqueIdentifier; targetZone: string } }\n  | { type: 'INSERT_ITEM'; payload: { item: T; parentId: string | null; index: number } }\n\n/**\n * Drag overlay renderer\n */\nexport interface DragOverlayProps<T extends BaseBlock = BaseBlock> {\n  block: T\n}\n\n/**\n * BlockTree configuration options\n */\nexport interface BlockTreeConfig {\n  activationDistance?: number\n  previewDebounce?: number\n  dropZoneHeight?: number\n}\n\n/**\n * Block state context value\n */\nexport interface BlockStateContextValue<T extends BaseBlock = BaseBlock> {\n  blocks: T[]\n  blockMap: Map<string, T>\n  childrenMap: Map<string | null, T[]>\n  indexMap: Map<string, number>\n  normalizedIndex: BlockIndex<T>\n  createItem: (type: T['type'], parentId?: string | null) => T\n  insertItem: (type: T['type'], referenceId: string, position: 'before' | 'after') => T\n  deleteItem: (id: string) => void\n  moveItem: (activeId: UniqueIdentifier, targetZone: string) => void\n  setAll: (blocks: T[]) => void\n}\n\n/**\n * Tree state context value (UI state)\n */\nexport interface TreeStateContextValue<T extends BaseBlock = BaseBlock> {\n  activeId: string | null\n  activeBlock: T | null\n  hoverZone: string | null\n  expandedMap: Record<string, boolean>\n  effectiveBlocks: T[]\n  blocksByParent: Map<string | null, T[]>\n  setActiveId: (id: string | null) => void\n  setHoverZone: (zone: string | null) => void\n  toggleExpand: (id: string) => void\n  setExpandAll: (expanded: boolean) => void\n  handleHover: (zoneId: string, parentId: string | null) => void\n}\n\n/**\n * Drop zone types\n */\nexport type DropZoneType = 'before' | 'after' | 'into'\n\n/**\n * Extract zone type from zone ID\n */\nexport function getDropZoneType(zoneId: string): DropZoneType {\n  if (zoneId.startsWith('before-')) return 'before'\n  if (zoneId.startsWith('into-')) return 'into'\n  return 'after'\n}\n\n/**\n * Extract block ID from zone ID\n */\nexport function extractBlockId(zoneId: string): string {\n  return zoneId.replace(/^(before|after|into)-/, '')\n}\n\n/**\n * Block state provider props\n */\nexport interface BlockStateProviderProps<T extends BaseBlock = BaseBlock> {\n  children: ReactNode\n  initialBlocks?: T[]\n  containerTypes?: readonly string[]\n  onChange?: (blocks: T[]) => void\n}\n\n/**\n * Tree state provider props\n */\nexport interface TreeStateProviderProps<T extends BaseBlock = BaseBlock> {\n  children: ReactNode\n  blocks: T[]\n  blockMap: Map<string, T>\n}\n","import type { CollisionDetection, CollisionDescriptor } from '@dnd-kit/core'\n\n/**\n * Custom collision detection that scores drop zones by distance to nearest edge.\n * Uses edge-distance scoring with a bottom bias for more natural drag behavior.\n *\n * Key features:\n * - Scores by distance to nearest edge (top or bottom) of droppable\n * - Applies -5px bias to elements below pointer midpoint (prefers dropping below)\n * - Returns single winner (lowest score)\n */\nexport const weightedVerticalCollision: CollisionDetection = ({\n  droppableContainers,\n  collisionRect,\n}) => {\n  if (!collisionRect) return []\n\n  const pointerY = collisionRect.top + collisionRect.height / 2\n\n  const candidates: CollisionDescriptor[] = droppableContainers\n    .map((container) => {\n      const rect = container.rect.current\n      if (!rect) return null\n\n      const distanceToTop = Math.abs(pointerY - rect.top)\n      const distanceToBottom = Math.abs(pointerY - rect.bottom)\n\n      // Use nearest edge distance\n      const edgeDistance = Math.min(distanceToTop, distanceToBottom)\n\n      // Apply small bias to prefer bottom drop zones\n      const isBelowCenter = pointerY > rect.top + rect.height / 2\n      const bias = isBelowCenter ? -5 : 0\n\n      return {\n        id: container.id,\n        data: {\n          droppableContainer: container,\n          value: edgeDistance + bias,\n        },\n      } as CollisionDescriptor\n    })\n    .filter((c): c is CollisionDescriptor => c !== null)\n\n  // Sort by score (lowest wins)\n  candidates.sort((a, b) => {\n    const aValue = (a.data as { value: number }).value\n    const bValue = (b.data as { value: number }).value\n    return aValue - bValue\n  })\n\n  // Return only the winner\n  return candidates.slice(0, 1)\n}\n\n/**\n * Simple closest center collision (fallback)\n */\nexport const closestCenterCollision: CollisionDetection = ({\n  droppableContainers,\n  collisionRect,\n}) => {\n  if (!collisionRect) return []\n\n  const centerY = collisionRect.top + collisionRect.height / 2\n  const centerX = collisionRect.left + collisionRect.width / 2\n\n  const candidates: CollisionDescriptor[] = droppableContainers\n    .map((container) => {\n      const rect = container.rect.current\n      if (!rect) return null\n\n      const containerCenterX = rect.left + rect.width / 2\n      const containerCenterY = rect.top + rect.height / 2\n\n      const distance = Math.sqrt(\n        Math.pow(centerX - containerCenterX, 2) + Math.pow(centerY - containerCenterY, 2)\n      )\n\n      return {\n        id: container.id,\n        data: {\n          droppableContainer: container,\n          value: distance,\n        },\n      } as CollisionDescriptor\n    })\n    .filter((c): c is CollisionDescriptor => c !== null)\n\n  candidates.sort((a, b) => {\n    const aValue = (a.data as { value: number }).value\n    const bValue = (b.data as { value: number }).value\n    return aValue - bValue\n  })\n\n  return candidates.slice(0, 1)\n}\n","import {\n  useSensor,\n  useSensors,\n  PointerSensor,\n  TouchSensor,\n  KeyboardSensor,\n} from '@dnd-kit/core'\n\nexport interface SensorConfig {\n  activationDistance?: number\n}\n\nconst DEFAULT_ACTIVATION_DISTANCE = 8\n\n/**\n * Create configured sensors with activation distance constraint.\n * The activation distance prevents accidental drags while still allowing clicks.\n *\n * @param config - Sensor configuration\n * @returns Configured sensors for DndContext\n */\nexport function useConfiguredSensors(config: SensorConfig = {}) {\n  const { activationDistance = DEFAULT_ACTIVATION_DISTANCE } = config\n\n  return useSensors(\n    useSensor(PointerSensor, {\n      activationConstraint: {\n        distance: activationDistance,\n      },\n    }),\n    useSensor(TouchSensor, {\n      activationConstraint: {\n        distance: activationDistance,\n      },\n    }),\n    useSensor(KeyboardSensor)\n  )\n}\n\n/**\n * Get sensor configuration for manual setup\n */\nexport function getSensorConfig(activationDistance = DEFAULT_ACTIVATION_DISTANCE) {\n  return {\n    pointer: {\n      activationConstraint: {\n        distance: activationDistance,\n      },\n    },\n    touch: {\n      activationConstraint: {\n        distance: activationDistance,\n      },\n    },\n  }\n}\n","/**\n * Extract UUID from a zone ID by removing the prefix (before-, after-, into-)\n */\nexport function extractUUID(id: string, pattern = '^(before|after|into)-'): string {\n  const regex = new RegExp(pattern)\n  return id.replace(regex, '')\n}\n\n/**\n * Create a debounced function\n */\nexport function debounce<Args extends unknown[]>(\n  fn: (...args: Args) => void,\n  delay: number\n): ((...args: Args) => void) & { cancel: () => void } {\n  let timeoutId: ReturnType<typeof setTimeout> | null = null\n\n  const debounced = ((...args: Args) => {\n    if (timeoutId) clearTimeout(timeoutId)\n    timeoutId = setTimeout(() => {\n      fn(...args)\n      timeoutId = null\n    }, delay)\n  }) as ((...args: Args) => void) & { cancel: () => void }\n\n  debounced.cancel = () => {\n    if (timeoutId) {\n      clearTimeout(timeoutId)\n      timeoutId = null\n    }\n  }\n\n  return debounced\n}\n\n/**\n * Generate a unique ID (simple implementation)\n */\nexport function generateId(): string {\n  return `${Date.now()}-${Math.random().toString(36).slice(2, 11)}`\n}\n","'use client'\n\nimport { useDroppable } from '@dnd-kit/core'\nimport { memo, useCallback, useEffect } from 'react'\nimport { extractUUID } from '../utils/helper'\n\nexport interface DropZoneProps {\n  id: string\n  parentId: string | null\n  onHover: (zoneId: string, parentId: string | null) => void\n  activeId: string | null\n  className?: string\n  activeClassName?: string\n  height?: number\n}\n\n/**\n * Drop zone indicator component\n * Shows where blocks can be dropped\n */\nfunction DropZoneComponent({\n  id,\n  parentId,\n  onHover,\n  activeId,\n  className = 'h-1 rounded transition-colors',\n  activeClassName = 'bg-blue-500',\n  height = 4,\n}: DropZoneProps) {\n  const { setNodeRef, isOver, active } = useDroppable({ id })\n\n  const handleInternalHover = useCallback(() => {\n    onHover(id, parentId)\n  }, [onHover, id, parentId])\n\n  useEffect(() => {\n    if (isOver) handleInternalHover()\n  }, [isOver, handleInternalHover])\n\n  // Hide zone if it belongs to the active block\n  if (active?.id && extractUUID(id) === String(active.id)) return null\n  // Also hide if activeId matches (from context)\n  if (activeId && extractUUID(id) === activeId) return null\n\n  return (\n    <div\n      ref={setNodeRef}\n      data-zone-id={id}\n      data-parent-id={parentId ?? ''}\n      style={{ height: isOver ? height * 2 : height }}\n      className={`${className} ${isOver ? activeClassName : 'bg-transparent'}`}\n    />\n  )\n}\n\nexport const DropZone = memo(DropZoneComponent)\n","'use client'\n\nimport { Fragment, type ReactNode } from 'react'\nimport { useDraggable } from '@dnd-kit/core'\nimport type { BaseBlock, InternalRenderers, ContainerRendererProps } from '../core/types'\nimport { DropZone } from './DropZone'\n\nexport interface TreeRendererProps<T extends BaseBlock> {\n  blocks: T[]\n  blocksByParent: Map<string | null, T[]>\n  parentId: string | null\n  activeId: string | null\n  expandedMap: Record<string, boolean>\n  renderers: InternalRenderers<T>\n  containerTypes: readonly string[]\n  onHover: (zoneId: string, parentId: string | null) => void\n  onToggleExpand: (id: string) => void\n  depth?: number\n  dropZoneClassName?: string\n  dropZoneActiveClassName?: string\n  indentClassName?: string\n  rootClassName?: string\n}\n\n/**\n * Draggable wrapper for individual blocks\n */\nfunction DraggableBlock<T extends BaseBlock>({\n  block,\n  children,\n}: {\n  block: T\n  children: (props: { isDragging: boolean }) => ReactNode\n}) {\n  const { attributes, listeners, setNodeRef, isDragging } = useDraggable({\n    id: block.id,\n  })\n\n  return (\n    <div ref={setNodeRef} {...attributes} {...listeners}>\n      {children({ isDragging })}\n    </div>\n  )\n}\n\n/**\n * Recursive tree renderer with smart drop zones\n */\nexport function TreeRenderer<T extends BaseBlock>({\n  blocks,\n  blocksByParent,\n  parentId,\n  activeId,\n  expandedMap,\n  renderers,\n  containerTypes,\n  onHover,\n  onToggleExpand,\n  depth = 0,\n  dropZoneClassName,\n  dropZoneActiveClassName,\n  indentClassName = 'ml-6 border-l border-gray-200 pl-4',\n  rootClassName = 'flex flex-col gap-1',\n}: TreeRendererProps<T>) {\n  const items = blocksByParent.get(parentId) ?? []\n\n  // Filter out the active block from visible items\n  const filteredBlocks = items.filter(block => block.id !== activeId)\n\n  // Find first visible block for the single before-zone\n  const firstVisibleBlockId = filteredBlocks[0]?.id\n\n  const containerClass = depth === 0 ? rootClassName : indentClassName\n\n  return (\n    <div className={containerClass}>\n      {filteredBlocks.map((block) => {\n        const isContainer = containerTypes.includes(block.type)\n        const isExpanded = expandedMap[block.id] !== false // Default to expanded\n        const Renderer = renderers[block.type as keyof typeof renderers]\n\n        if (!Renderer) {\n          console.warn(`No renderer found for block type: ${block.type}`)\n          return null\n        }\n\n        return (\n          <Fragment key={block.id}>\n            {/* Before-zone: only for the first visible non-active block */}\n            {block.id === firstVisibleBlockId && (\n              <DropZone\n                id={`before-${block.id}`}\n                parentId={block.parentId}\n                onHover={onHover}\n                activeId={activeId}\n                className={dropZoneClassName}\n                activeClassName={dropZoneActiveClassName}\n              />\n            )}\n\n            {/* Render the block */}\n            <DraggableBlock block={block}>\n              {({ isDragging }) => {\n                if (isContainer) {\n                  const childContent = isExpanded ? (\n                    <>\n                      {/* Into-zone for dropping inside */}\n                      <DropZone\n                        id={`into-${block.id}`}\n                        parentId={block.id}\n                        onHover={onHover}\n                        activeId={activeId}\n                        className={dropZoneClassName}\n                        activeClassName={dropZoneActiveClassName}\n                      />\n                      <TreeRenderer\n                        blocks={blocks}\n                        blocksByParent={blocksByParent}\n                        parentId={block.id}\n                        activeId={activeId}\n                        expandedMap={expandedMap}\n                        renderers={renderers}\n                        containerTypes={containerTypes}\n                        onHover={onHover}\n                        onToggleExpand={onToggleExpand}\n                        depth={depth + 1}\n                        dropZoneClassName={dropZoneClassName}\n                        dropZoneActiveClassName={dropZoneActiveClassName}\n                        indentClassName={indentClassName}\n                        rootClassName={rootClassName}\n                      />\n                    </>\n                  ) : null\n\n                  return Renderer({\n                    block: block as T & { type: typeof block.type },\n                    children: childContent,\n                    isDragging,\n                    depth,\n                    isExpanded,\n                    onToggleExpand: () => onToggleExpand(block.id),\n                  } as ContainerRendererProps<T & { type: typeof block.type }>)\n                }\n\n                return Renderer({\n                  block: block as T & { type: typeof block.type },\n                  isDragging,\n                  depth,\n                })\n              }}\n            </DraggableBlock>\n\n            {/* After-zone */}\n            <DropZone\n              id={`after-${block.id}`}\n              parentId={block.parentId}\n              onHover={onHover}\n              activeId={activeId}\n              className={dropZoneClassName}\n              activeClassName={dropZoneActiveClassName}\n            />\n          </Fragment>\n        )\n      })}\n    </div>\n  )\n}\n","'use client'\n\nimport { DragOverlay as DndKitDragOverlay } from '@dnd-kit/core'\nimport type { ReactNode } from 'react'\nimport type { BaseBlock } from '../core/types'\n\nexport interface DragOverlayProps<T extends BaseBlock> {\n  activeBlock: T | null\n  children?: (block: T) => ReactNode\n}\n\n/**\n * Default drag overlay component\n * Shows a preview of the dragged item\n */\nexport function DragOverlay<T extends BaseBlock>({\n  activeBlock,\n  children,\n}: DragOverlayProps<T>) {\n  return (\n    <DndKitDragOverlay>\n      {activeBlock && (\n        children ? (\n          children(activeBlock)\n        ) : (\n          <div className=\"bg-white border border-gray-300 shadow-md rounded-md p-3 text-sm w-64 pointer-events-none\">\n            <div className=\"text-gray-500 uppercase text-xs tracking-wide mb-1\">\n              {activeBlock.type}\n            </div>\n            <div className=\"font-semibold text-gray-800\">\n              Block {activeBlock.id.slice(0, 8)}\n            </div>\n          </div>\n        )\n      )}\n    </DndKitDragOverlay>\n  )\n}\n","import type { UniqueIdentifier } from '@dnd-kit/core'\nimport type { BaseBlock, BlockIndex } from '../core/types'\nimport { extractUUID } from './helper'\n\n/**\n * Clone a Map\n */\nexport function cloneMap<K, V>(map: Map<K, V>): Map<K, V> {\n  return new Map(map)\n}\n\n/**\n * Clone a parent map with arrays\n */\nexport function cloneParentMap(map: Map<string | null, string[]>): Map<string | null, string[]> {\n  const newMap = new Map<string | null, string[]>()\n  for (const [k, v] of map.entries()) {\n    newMap.set(k, [...v])\n  }\n  return newMap\n}\n\n/**\n * Compute normalized index from flat block array\n */\nexport function computeNormalizedIndex<T extends BaseBlock>(blocks: T[]): BlockIndex<T> {\n  const byId = new Map<string, T>()\n  const byParent = new Map<string | null, string[]>()\n\n  for (const block of blocks) {\n    byId.set(block.id, block)\n    const key = block.parentId ?? null\n    const list = byParent.get(key) ?? []\n    byParent.set(key, [...list, block.id])\n  }\n\n  return { byId, byParent }\n}\n\n/**\n * Build ordered flat array from BlockIndex\n */\nexport function buildOrderedBlocks<T extends BaseBlock>(\n  index: BlockIndex<T>,\n  containerTypes: readonly string[] = []\n): T[] {\n  const result: T[] = []\n\n  const walk = (parentId: string | null) => {\n    const children = index.byParent.get(parentId) ?? []\n    for (let i = 0; i < children.length; i++) {\n      const id = children[i]\n      const block = index.byId.get(id)\n      if (block) {\n        result.push({ ...block, order: i })\n        // Recursively walk children if this is a container type\n        if (containerTypes.includes(block.type)) {\n          walk(block.id)\n        }\n      }\n    }\n  }\n\n  walk(null)\n  return result\n}\n\n/**\n * Reparent a block based on drop zone ID\n *\n * @param state - Current block index\n * @param activeId - ID of the dragged block\n * @param targetZone - Drop zone ID (e.g., \"after-uuid\", \"before-uuid\", \"into-uuid\")\n * @param containerTypes - Block types that can have children\n */\nexport function reparentBlockIndex<T extends BaseBlock>(\n  state: BlockIndex<T>,\n  activeId: UniqueIdentifier,\n  targetZone: string,\n  containerTypes: readonly string[] = []\n): BlockIndex<T> {\n  const byId = cloneMap(state.byId)\n  const byParent = cloneParentMap(state.byParent)\n\n  const dragged = byId.get(String(activeId))\n  if (!dragged) return state\n\n  const zoneTargetId = extractUUID(targetZone)\n  const isAfter = targetZone.startsWith('after-')\n  const isInto = targetZone.startsWith('into-')\n  const target = byId.get(zoneTargetId)\n\n  const oldParentId = dragged.parentId ?? null\n  const newParentId = isInto ? zoneTargetId : target?.parentId ?? null\n\n  // Prevent containers from being nested if they shouldn't be\n  if (containerTypes.includes(dragged.type) && newParentId !== null) {\n    const newParent = byId.get(newParentId)\n    // Only allow nesting if the parent is also a container type\n    // For now, prevent top-level containers from being nested\n    if (newParent && !containerTypes.includes(newParent.type)) {\n      return state\n    }\n  }\n\n  // Cannot drop on itself\n  if (dragged.id === zoneTargetId) return state\n\n  // Remove dragged from old parent\n  const oldList = byParent.get(oldParentId) ?? []\n  const filtered = oldList.filter(id => id !== dragged.id)\n  byParent.set(oldParentId, filtered)\n\n  // Insert dragged into new parent\n  const newList = [...(byParent.get(newParentId) ?? [])]\n  let insertIndex = newList.length\n\n  if (!isInto) {\n    const idx = newList.indexOf(zoneTargetId)\n    insertIndex = idx === -1 ? newList.length : isAfter ? idx + 1 : idx\n  }\n\n  // Check if already at correct position\n  const currentIndex = newList.indexOf(dragged.id)\n  if (dragged.parentId === newParentId && currentIndex === insertIndex) {\n    return state\n  }\n\n  newList.splice(insertIndex, 0, dragged.id)\n  byParent.set(newParentId, newList)\n\n  // Update dragged block's parentId\n  byId.set(dragged.id, {\n    ...dragged,\n    parentId: newParentId,\n  })\n\n  return { byId, byParent }\n}\n\n/**\n * Get all descendant IDs of a block\n */\nexport function getDescendantIds<T extends BaseBlock>(\n  state: BlockIndex<T>,\n  parentId: string\n): Set<string> {\n  const toDelete = new Set<string>()\n  const stack = [parentId]\n\n  while (stack.length > 0) {\n    const current = stack.pop()!\n    toDelete.add(current)\n    const children = state.byParent.get(current) ?? []\n    stack.push(...children)\n  }\n\n  return toDelete\n}\n\n/**\n * Delete a block and all its descendants\n */\nexport function deleteBlockAndDescendants<T extends BaseBlock>(\n  state: BlockIndex<T>,\n  id: string\n): BlockIndex<T> {\n  const byId = cloneMap(state.byId)\n  const byParent = cloneParentMap(state.byParent)\n\n  const idsToDelete = getDescendantIds(state, id)\n\n  for (const deleteId of idsToDelete) {\n    byId.delete(deleteId)\n    byParent.delete(deleteId)\n  }\n\n  for (const [parent, list] of byParent.entries()) {\n    byParent.set(parent, list.filter(itemId => !idsToDelete.has(itemId)))\n  }\n\n  return { byId, byParent }\n}\n","'use client'\n\nimport { useCallback, useRef, useReducer, type ReactNode } from 'react'\nimport {\n  DndContext,\n  DragStartEvent,\n  DragEndEvent,\n  DragOverEvent,\n} from '@dnd-kit/core'\nimport type { BaseBlock, BlockRenderers, BlockIndex, InternalRenderers } from '../core/types'\nimport { weightedVerticalCollision } from '../core/collision'\nimport { useConfiguredSensors } from '../core/sensors'\nimport { TreeRenderer } from './TreeRenderer'\nimport { DragOverlay } from './DragOverlay'\nimport {\n  computeNormalizedIndex,\n  reparentBlockIndex,\n  buildOrderedBlocks,\n} from '../utils/blocks'\nimport { debounce } from '../utils/helper'\n\nexport interface BlockTreeProps<\n  T extends BaseBlock,\n  C extends readonly T['type'][] = readonly T['type'][]\n> {\n  /** Current blocks array */\n  blocks: T[]\n  /** Block renderers for each type */\n  renderers: BlockRenderers<T, C>\n  /** Block types that can have children */\n  containerTypes?: C\n  /** Called when blocks are reordered */\n  onChange?: (blocks: T[]) => void\n  /** Custom drag overlay renderer */\n  dragOverlay?: (block: T) => ReactNode\n  /** Activation distance in pixels (default: 8) */\n  activationDistance?: number\n  /** Preview debounce in ms (default: 150) */\n  previewDebounce?: number\n  /** Root container className */\n  className?: string\n  /** Drop zone className */\n  dropZoneClassName?: string\n  /** Active drop zone className */\n  dropZoneActiveClassName?: string\n  /** Indent className for nested items */\n  indentClassName?: string\n}\n\ninterface InternalState<T extends BaseBlock> {\n  activeId: string | null\n  hoverZone: string | null\n  expandedMap: Record<string, boolean>\n  virtualState: BlockIndex<T> | null\n}\n\n/**\n * Main BlockTree component\n * Provides drag-and-drop functionality for hierarchical block structures\n */\nexport function BlockTree<\n  T extends BaseBlock,\n  C extends readonly T['type'][] = readonly T['type'][]\n>({\n  blocks,\n  renderers,\n  containerTypes = [] as unknown as C,\n  onChange,\n  dragOverlay,\n  activationDistance = 8,\n  previewDebounce = 150,\n  className = 'flex flex-col gap-1',\n  dropZoneClassName,\n  dropZoneActiveClassName,\n  indentClassName,\n}: BlockTreeProps<T, C>) {\n  const sensors = useConfiguredSensors({ activationDistance })\n\n  // Internal state refs\n  const stateRef = useRef<InternalState<T>>({\n    activeId: null,\n    hoverZone: null,\n    expandedMap: {},\n    virtualState: null,\n  })\n\n  // Snapshot refs for stable drag computation\n  const initialBlocksRef = useRef<T[]>([])\n  const cachedReorderRef = useRef<{ targetId: string; reorderedBlocks: T[] } | null>(null)\n\n  // Force re-render\n  const [, forceRender] = useReducer((x: number) => x + 1, 0)\n\n  // Debounced virtual state setter\n  const debouncedSetVirtual = useRef(\n    debounce((newBlocks: T[] | null) => {\n      if (newBlocks) {\n        stateRef.current.virtualState = computeNormalizedIndex(newBlocks)\n      } else {\n        stateRef.current.virtualState = null\n      }\n      forceRender()\n    }, previewDebounce)\n  ).current\n\n  // Compute effective state\n  const effectiveIndex = stateRef.current.virtualState ?? computeNormalizedIndex(blocks)\n\n  // Blocks by parent for rendering\n  const blocksByParent = new Map<string | null, T[]>()\n  for (const [parentId, ids] of effectiveIndex.byParent.entries()) {\n    blocksByParent.set(\n      parentId,\n      ids.map(id => effectiveIndex.byId.get(id)!).filter(Boolean)\n    )\n  }\n\n  // Active block\n  const activeBlock = stateRef.current.activeId\n    ? effectiveIndex.byId.get(stateRef.current.activeId) ?? null\n    : null\n\n  // Handle drag start\n  const handleDragStart = useCallback((event: DragStartEvent) => {\n    const id = String(event.active.id)\n    stateRef.current.activeId = id\n    initialBlocksRef.current = [...blocks]\n    cachedReorderRef.current = null\n    forceRender()\n  }, [blocks])\n\n  // Handle drag over\n  const handleDragOver = useCallback((event: DragOverEvent) => {\n    if (!event.over) return\n\n    const targetZone = String(event.over.id)\n    const activeId = stateRef.current.activeId\n\n    if (!activeId) return\n\n    stateRef.current.hoverZone = targetZone\n\n    // Compute preview from snapshot\n    const baseIndex = computeNormalizedIndex(initialBlocksRef.current)\n    const updatedIndex = reparentBlockIndex(baseIndex, activeId, targetZone, containerTypes)\n    const orderedBlocks = buildOrderedBlocks(updatedIndex, containerTypes)\n\n    // Cache for drag end\n    cachedReorderRef.current = { targetId: targetZone, reorderedBlocks: orderedBlocks }\n\n    // Debounced preview update\n    debouncedSetVirtual(orderedBlocks)\n  }, [containerTypes, debouncedSetVirtual])\n\n  // Handle drag end\n  const handleDragEnd = useCallback((_event: DragEndEvent) => {\n    debouncedSetVirtual.cancel()\n\n    const cached = cachedReorderRef.current\n\n    // Reset state\n    stateRef.current.activeId = null\n    stateRef.current.hoverZone = null\n    stateRef.current.virtualState = null\n    cachedReorderRef.current = null\n    initialBlocksRef.current = []\n\n    // Notify parent of change\n    if (cached && onChange) {\n      onChange(cached.reorderedBlocks)\n    }\n\n    forceRender()\n  }, [debouncedSetVirtual, onChange])\n\n  // Handle hover from drop zones\n  const handleHover = useCallback((zoneId: string, _parentId: string | null) => {\n    const activeId = stateRef.current.activeId\n    if (!activeId) return\n\n    stateRef.current.hoverZone = zoneId\n\n    // Compute preview from snapshot\n    const baseIndex = computeNormalizedIndex(initialBlocksRef.current)\n    const updatedIndex = reparentBlockIndex(baseIndex, activeId, zoneId, containerTypes)\n    const orderedBlocks = buildOrderedBlocks(updatedIndex, containerTypes)\n\n    // Cache for drag end\n    cachedReorderRef.current = { targetId: zoneId, reorderedBlocks: orderedBlocks }\n\n    // Debounced preview update\n    debouncedSetVirtual(orderedBlocks)\n  }, [containerTypes, debouncedSetVirtual])\n\n  // Handle expand toggle\n  const handleToggleExpand = useCallback((id: string) => {\n    stateRef.current.expandedMap = {\n      ...stateRef.current.expandedMap,\n      [id]: stateRef.current.expandedMap[id] === false,\n    }\n    forceRender()\n  }, [])\n\n  return (\n    <DndContext\n      sensors={sensors}\n      collisionDetection={weightedVerticalCollision}\n      onDragStart={handleDragStart}\n      onDragOver={handleDragOver}\n      onDragEnd={handleDragEnd}\n    >\n      <div className={className}>\n        <TreeRenderer\n          blocks={blocks}\n          blocksByParent={blocksByParent}\n          parentId={null}\n          activeId={stateRef.current.activeId}\n          expandedMap={stateRef.current.expandedMap}\n          renderers={renderers as InternalRenderers<T>}\n          containerTypes={containerTypes}\n          onHover={handleHover}\n          onToggleExpand={handleToggleExpand}\n          dropZoneClassName={dropZoneClassName}\n          dropZoneActiveClassName={dropZoneActiveClassName}\n          indentClassName={indentClassName}\n          rootClassName={className}\n        />\n      </div>\n      <DragOverlay activeBlock={activeBlock}>\n        {dragOverlay}\n      </DragOverlay>\n    </DndContext>\n  )\n}\n","'use client'\n\nimport {\n  createContext,\n  useContext,\n  useReducer,\n  useMemo,\n  useCallback,\n  useState,\n  type ReactNode,\n} from 'react'\nimport type { UniqueIdentifier } from '@dnd-kit/core'\nimport type { BaseBlock, BlockIndex, BlockAction, BlockStateContextValue, BlockStateProviderProps } from '../core/types'\nimport {\n  cloneMap,\n  cloneParentMap,\n  computeNormalizedIndex,\n  reparentBlockIndex,\n  deleteBlockAndDescendants,\n} from '../utils/blocks'\nimport { generateId } from '../utils/helper'\n\n/**\n * Block reducer for state management\n */\nfunction blockReducer<T extends BaseBlock>(\n  state: BlockIndex<T>,\n  action: BlockAction<T>,\n  containerTypes: readonly string[] = []\n): BlockIndex<T> {\n  switch (action.type) {\n    case 'ADD_ITEM': {\n      const byId = cloneMap(state.byId)\n      const byParent = cloneParentMap(state.byParent)\n      const item = action.payload\n\n      byId.set(item.id, item)\n\n      const parentKey = item.parentId ?? null\n      const list = byParent.get(parentKey) ?? []\n\n      const insertAt =\n        typeof item.order === 'number' && item.order <= list.length\n          ? item.order\n          : list.length\n\n      const newList = [...list]\n      newList.splice(insertAt, 0, item.id)\n      byParent.set(parentKey, newList)\n\n      return { byId, byParent }\n    }\n\n    case 'INSERT_ITEM': {\n      const { item, parentId, index } = action.payload\n      const updated = new Map(state.byParent)\n      const siblings = [...(updated.get(parentId) ?? [])]\n      siblings.splice(index, 0, item.id)\n      updated.set(parentId, siblings)\n\n      return {\n        byId: new Map(state.byId).set(item.id, item),\n        byParent: updated,\n      }\n    }\n\n    case 'DELETE_ITEM': {\n      return deleteBlockAndDescendants(state, action.payload.id)\n    }\n\n    case 'SET_ALL': {\n      return computeNormalizedIndex(action.payload)\n    }\n\n    case 'MOVE_ITEM': {\n      return reparentBlockIndex(\n        state,\n        action.payload.activeId,\n        action.payload.targetZone,\n        containerTypes\n      )\n    }\n\n    default:\n      return state\n  }\n}\n\n/**\n * Create block state context and hooks\n */\nexport function createBlockState<T extends BaseBlock>() {\n  const BlockContext = createContext<BlockStateContextValue<T> | null>(null)\n\n  function useBlockState() {\n    const ctx = useContext(BlockContext)\n    if (!ctx) throw new Error('useBlockState must be used inside BlockStateProvider')\n    return ctx\n  }\n\n  function BlockStateProvider({\n    children,\n    initialBlocks = [],\n    containerTypes = [],\n    onChange,\n  }: BlockStateProviderProps<T>) {\n    const reducerWithContainerTypes = useCallback(\n      (state: BlockIndex<T>, action: BlockAction<T>) =>\n        blockReducer(state, action, containerTypes),\n      [containerTypes]\n    )\n\n    const [state, dispatch] = useReducer(\n      reducerWithContainerTypes,\n      computeNormalizedIndex(initialBlocks)\n    )\n    const [lastCreatedItem, setLastCreatedItem] = useState<T | null>(null)\n\n    // Compute flat blocks array\n    const blocks = useMemo(() => {\n      const result: T[] = []\n      const walk = (parentId: string | null) => {\n        const children = state.byParent.get(parentId) ?? []\n        for (let i = 0; i < children.length; i++) {\n          const id = children[i]\n          const b = state.byId.get(id)\n          if (b) {\n            result.push({ ...b, order: i })\n            if (containerTypes.includes(b.type)) walk(b.id)\n          }\n        }\n      }\n      walk(null)\n      return result\n    }, [state, containerTypes])\n\n    // Notify on change\n    useMemo(() => {\n      onChange?.(blocks)\n    }, [blocks, onChange])\n\n    const blockMap = useMemo(() => state.byId, [state])\n\n    const childrenMap = useMemo(() => {\n      const map = new Map<string | null, T[]>()\n      for (const [parentId, ids] of state.byParent.entries()) {\n        map.set(\n          parentId,\n          ids.map(id => state.byId.get(id)!).filter(Boolean)\n        )\n      }\n      return map\n    }, [state])\n\n    const indexMap = useMemo(() => {\n      const map = new Map<string, number>()\n      for (const ids of state.byParent.values()) {\n        ids.forEach((id, index) => {\n          map.set(id, index)\n        })\n      }\n      return map\n    }, [state])\n\n    const createItem = useCallback(\n      (type: T['type'], parentId: string | null = null): T => {\n        const newItem = {\n          id: generateId(),\n          type,\n          parentId,\n          order: 0,\n        } as T\n\n        dispatch({ type: 'ADD_ITEM', payload: newItem })\n        setLastCreatedItem(newItem)\n        return newItem\n      },\n      []\n    )\n\n    const insertItem = useCallback(\n      (type: T['type'], referenceId: string, position: 'before' | 'after'): T => {\n        const referenceBlock = state.byId.get(referenceId)\n        if (!referenceBlock) throw new Error(`Reference block ${referenceId} not found`)\n\n        const parentId = referenceBlock.parentId ?? null\n        const siblings = state.byParent.get(parentId) ?? []\n        const index = siblings.indexOf(referenceId)\n        const insertIndex = position === 'before' ? index : index + 1\n\n        const newItem = {\n          id: generateId(),\n          type,\n          parentId,\n          order: insertIndex,\n        } as T\n\n        dispatch({\n          type: 'INSERT_ITEM',\n          payload: { item: newItem, parentId, index: insertIndex },\n        })\n\n        setLastCreatedItem(newItem)\n        return newItem\n      },\n      [state]\n    )\n\n    const deleteItem = useCallback((id: string) => {\n      dispatch({ type: 'DELETE_ITEM', payload: { id } })\n    }, [])\n\n    const moveItem = useCallback((activeId: UniqueIdentifier, targetZone: string) => {\n      dispatch({ type: 'MOVE_ITEM', payload: { activeId, targetZone } })\n    }, [])\n\n    const setAll = useCallback((all: T[]) => {\n      dispatch({ type: 'SET_ALL', payload: all })\n    }, [])\n\n    const value: BlockStateContextValue<T> = useMemo(\n      () => ({\n        blocks,\n        blockMap,\n        childrenMap,\n        indexMap,\n        normalizedIndex: state,\n        createItem,\n        insertItem,\n        deleteItem,\n        moveItem,\n        setAll,\n      }),\n      [\n        blocks,\n        blockMap,\n        childrenMap,\n        indexMap,\n        state,\n        createItem,\n        insertItem,\n        deleteItem,\n        moveItem,\n        setAll,\n      ]\n    )\n\n    return <BlockContext.Provider value={value}>{children}</BlockContext.Provider>\n  }\n\n  return {\n    BlockStateProvider,\n    useBlockState,\n  }\n}\n","'use client'\n\nimport {\n  createContext,\n  useContext,\n  useState,\n  useMemo,\n  useCallback,\n  useReducer,\n  useRef,\n  useEffect,\n  type ReactNode,\n} from 'react'\nimport type { BaseBlock, BlockIndex, TreeStateContextValue, TreeStateProviderProps } from '../core/types'\nimport { computeNormalizedIndex, reparentBlockIndex, buildOrderedBlocks } from '../utils/blocks'\nimport { debounce } from '../utils/helper'\n\ntype ExpandAction =\n  | { type: 'TOGGLE'; id: string }\n  | { type: 'SET_ALL'; expanded: boolean; ids: string[] }\n\nfunction expandReducer(\n  state: Record<string, boolean>,\n  action: ExpandAction\n): Record<string, boolean> {\n  switch (action.type) {\n    case 'TOGGLE':\n      return { ...state, [action.id]: !state[action.id] }\n    case 'SET_ALL': {\n      const newState: Record<string, boolean> = {}\n      for (const id of action.ids) {\n        newState[id] = action.expanded\n      }\n      return newState\n    }\n    default:\n      return state\n  }\n}\n\ninterface CreateTreeStateOptions<T extends BaseBlock> {\n  previewDebounce?: number\n  containerTypes?: string[]\n}\n\n/**\n * Create tree state context and hooks\n * Handles UI state: active drag, hover zone, expand/collapse, virtual preview\n */\nexport function createTreeState<T extends BaseBlock>(options: CreateTreeStateOptions<T> = {}) {\n  const { previewDebounce = 150, containerTypes = [] } = options\n\n  const TreeContext = createContext<TreeStateContextValue<T> | null>(null)\n\n  function useTreeState() {\n    const ctx = useContext(TreeContext)\n    if (!ctx) throw new Error('useTreeState must be used inside TreeStateProvider')\n    return ctx\n  }\n\n  function TreeStateProvider({ children, blocks, blockMap }: TreeStateProviderProps<T>) {\n    const [activeId, setActiveId] = useState<string | null>(null)\n    const [hoverZone, setHoverZone] = useState<string | null>(null)\n\n    // Virtual state for debounced preview\n    const [virtualState, setVirtualState] = useState<BlockIndex<T> | null>(null)\n\n    // Expand/collapse state\n    const [expandedMap, dispatchExpand] = useReducer(expandReducer, {})\n\n    // Snapshot-based computation refs\n    const initialBlocksRef = useRef<T[]>([])\n    const cachedReorderRef = useRef<{ targetId: string; reorderedBlocks: T[] } | null>(null)\n\n    // Get active block\n    const activeBlock = useMemo(() => {\n      if (!activeId) return null\n      return blockMap.get(activeId) ?? null\n    }, [activeId, blockMap])\n\n    // Debounced virtual state setter\n    const debouncedSetVirtualBlocks = useMemo(\n      () =>\n        debounce((newBlocks: T[] | null) => {\n          if (!newBlocks) {\n            setVirtualState(null)\n          } else {\n            setVirtualState(computeNormalizedIndex(newBlocks))\n          }\n        }, previewDebounce),\n      [previewDebounce]\n    )\n\n    // Compute effective state (virtual takes precedence)\n    const effectiveState = useMemo(() => {\n      return virtualState ?? computeNormalizedIndex(blocks)\n    }, [virtualState, blocks])\n\n    // Compute effective blocks array\n    const effectiveBlocks = useMemo(() => {\n      return buildOrderedBlocks(effectiveState, containerTypes)\n    }, [effectiveState, containerTypes])\n\n    // Blocks by parent for rendering\n    const blocksByParent = useMemo(() => {\n      const map = new Map<string | null, T[]>()\n      for (const [parentId, ids] of effectiveState.byParent.entries()) {\n        map.set(\n          parentId,\n          ids.map(id => effectiveState.byId.get(id)!).filter(Boolean)\n        )\n      }\n      return map\n    }, [effectiveState])\n\n    // Handle drag start - capture snapshot\n    const handleDragStart = useCallback(\n      (id: string | null) => {\n        setActiveId(id)\n        if (id) {\n          initialBlocksRef.current = [...blocks]\n          cachedReorderRef.current = null\n        }\n      },\n      [blocks]\n    )\n\n    // Handle drag over - compute preview\n    const handleDragOver = useCallback(\n      (targetZone: string) => {\n        if (!activeId) return\n\n        setHoverZone(targetZone)\n\n        // Compute preview from snapshot\n        const baseIndex = computeNormalizedIndex(initialBlocksRef.current)\n        const updatedIndex = reparentBlockIndex(baseIndex, activeId, targetZone, containerTypes)\n        const orderedBlocks = buildOrderedBlocks(updatedIndex, containerTypes)\n\n        // Cache for drag end\n        cachedReorderRef.current = { targetId: targetZone, reorderedBlocks: orderedBlocks }\n\n        // Debounced preview update\n        debouncedSetVirtualBlocks(orderedBlocks)\n      },\n      [activeId, debouncedSetVirtualBlocks, containerTypes]\n    )\n\n    // Handle drag end - return cached result\n    const handleDragEnd = useCallback(() => {\n      debouncedSetVirtualBlocks.cancel()\n      setVirtualState(null)\n      setActiveId(null)\n      setHoverZone(null)\n\n      const result = cachedReorderRef.current\n      cachedReorderRef.current = null\n      initialBlocksRef.current = []\n\n      return result\n    }, [debouncedSetVirtualBlocks])\n\n    // Hover handler for drop zones\n    const handleHover = useCallback(\n      (zoneId: string, _parentId: string | null) => {\n        if (!activeId) return\n        handleDragOver(zoneId)\n      },\n      [activeId, handleDragOver]\n    )\n\n    // Expand/collapse handlers\n    const toggleExpand = useCallback((id: string) => {\n      dispatchExpand({ type: 'TOGGLE', id })\n    }, [])\n\n    const setExpandAll = useCallback(\n      (expanded: boolean) => {\n        const containerIds = blocks.filter(b => containerTypes.includes(b.type)).map(b => b.id)\n        dispatchExpand({ type: 'SET_ALL', expanded, ids: containerIds })\n      },\n      [blocks, containerTypes]\n    )\n\n    // Cleanup on unmount\n    useEffect(() => {\n      return () => {\n        debouncedSetVirtualBlocks.cancel()\n      }\n    }, [debouncedSetVirtualBlocks])\n\n    const value: TreeStateContextValue<T> = useMemo(\n      () => ({\n        activeId,\n        activeBlock,\n        hoverZone,\n        expandedMap,\n        effectiveBlocks,\n        blocksByParent,\n        setActiveId: handleDragStart,\n        setHoverZone,\n        toggleExpand,\n        setExpandAll,\n        handleHover,\n      }),\n      [\n        activeId,\n        activeBlock,\n        hoverZone,\n        expandedMap,\n        effectiveBlocks,\n        blocksByParent,\n        handleDragStart,\n        toggleExpand,\n        setExpandAll,\n        handleHover,\n      ]\n    )\n\n    return <TreeContext.Provider value={value}>{children}</TreeContext.Provider>\n  }\n\n  return {\n    TreeStateProvider,\n    useTreeState,\n  }\n}\n"]}