## Utilities

All exported utility functions for tree operations, ID handling, fractional indexing, and more.

<CalloutCard title="Package Provenance">

All utilities below are available from `@dnd-block-tree/react`. Functions marked **core** are also available from `@dnd-block-tree/core` (no React dependency). Functions marked **react** require `@dnd-block-tree/react`.

</CalloutCard>

### Tree Operations

All tree operations are **core** exports.

#### computeNormalizedIndex

Build a `BlockIndex` from a flat block array for O(1) lookups.

```typescript
function computeNormalizedIndex<T extends BaseBlock>(
  blocks: T[],
  orderingStrategy?: OrderingStrategy
): BlockIndex<T>
```

#### buildOrderedBlocks

Convert a `BlockIndex` back to an ordered flat array.

```typescript
function buildOrderedBlocks<T extends BaseBlock>(
  index: BlockIndex<T>,
  containerTypes?: readonly string[],
  orderingStrategy?: OrderingStrategy
): T[]
```

#### reparentBlockIndex

Move a single block to a new position in the index.

```typescript
function reparentBlockIndex<T extends BaseBlock>(
  state: BlockIndex<T>,
  activeId: string,
  targetZone: string,
  containerTypes?: readonly string[],
  orderingStrategy?: OrderingStrategy,
  maxDepth?: number
): BlockIndex<T>
```

#### reparentMultipleBlocks

Move multiple blocks to a new position, preserving their relative order.

```typescript
function reparentMultipleBlocks<T extends BaseBlock>(
  state: BlockIndex<T>,
  blockIds: string[],
  targetZone: string,
  containerTypes?: readonly string[],
  orderingStrategy?: OrderingStrategy,
  maxDepth?: number
): BlockIndex<T>
```

#### getDescendantIds

Get all descendant IDs of a block (recursive).

```typescript
function getDescendantIds<T extends BaseBlock>(
  state: BlockIndex<T>,
  parentId: string
): Set<string>
```

#### deleteBlockAndDescendants

Remove a block and all its descendants from the index.

```typescript
function deleteBlockAndDescendants<T extends BaseBlock>(
  state: BlockIndex<T>,
  id: string
): BlockIndex<T>
```

#### getBlockDepth

Get the nesting depth of a block (root level = 1).

```typescript
function getBlockDepth<T extends BaseBlock>(
  index: BlockIndex<T>,
  blockId: string
): number
```

#### getSubtreeDepth

Get the depth of a block's subtree (leaf = 1).

```typescript
function getSubtreeDepth<T extends BaseBlock>(
  index: BlockIndex<T>,
  blockId: string
): number
```

#### validateBlockTree

Validate a tree for cycles, orphans, and stale references. Returns `{ valid: boolean; issues: string[] }`.

```typescript
function validateBlockTree<T extends BaseBlock>(
  index: BlockIndex<T>
): TreeValidationResult
```

### Tree Factory

**Core** export. Create a stateful tree instance with event-driven updates — useful for server-side manipulation, testing, or non-React frameworks.

#### createBlockTree

```typescript
function createBlockTree<T extends BaseBlock>(
  options?: BlockTreeOptions<T>
): BlockTreeInstance<T>
```

The returned `BlockTreeInstance` provides methods for reading state (`getBlocks`, `getBlock`, `getChildren`), mutations (`addBlock`, `deleteBlock`, `moveBlock`, `setBlocks`), expand/collapse (`toggleExpand`, `setExpandAll`), drag lifecycle (`startDrag`, `updateDrag`, `endDrag`), and typed event subscription (`on`, `off`).

See [@dnd-block-tree/core README](https://www.npmjs.com/package/@dnd-block-tree/core) for a usage example.

### Reducers

**Core** exports. Pure reducer functions for immutable state management.

#### blockReducer

Handles block add/delete/move/insert operations on a `BlockIndex`.

```typescript
function blockReducer<T extends BaseBlock>(
  state: BlockIndex<T>,
  action: BlockAction<T>,
  containerTypes?: readonly string[],
  orderingStrategy?: OrderingStrategy,
  maxDepth?: number
): BlockIndex<T>
```

#### expandReducer

Manages expand/collapse state for container blocks.

```typescript
function expandReducer(
  state: Record<string, boolean>,
  action: ExpandAction
): Record<string, boolean>
```

#### historyReducer

Manages undo/redo history stacks.

```typescript
function historyReducer<T>(
  state: HistoryState<T>,
  action: HistoryAction<T>
): HistoryState<T>
```

### Event Emitter

**Core** export. Typed event emitter for subscribe/unsubscribe patterns.

```typescript
class EventEmitter<T extends Record<string, (...args: any[]) => void>> {
  on<K extends keyof T>(event: K, handler: T[K]): void
  off<K extends keyof T>(event: K, handler: T[K]): void
  emit<K extends keyof T>(event: K, ...args: Parameters<T[K]>): void
  removeAllListeners(): void
}
```

### Map Utilities

**Core** exports.

#### cloneMap / cloneParentMap

Efficiently clone `Map` structures used in `BlockIndex`.

```typescript
function cloneMap<K, V>(map: Map<K, V>): Map<K, V>
function cloneParentMap(map: Map<string | null, string[]>): Map<string | null, string[]>
```

### ID & Zone Helpers

#### extractUUID

**Core.** Extract the block ID from a zone ID string (removes the prefix like `"before-"`, `"into-"`, etc.).

```typescript
function extractUUID(id: string, pattern?: string): string
```

#### extractBlockId

**Core.** Alias for `extractUUID` — extracts the block ID from a zone ID.

```typescript
function extractBlockId(zoneId: string): string
```

#### getDropZoneType

**Core.** Parse the zone type from a zone ID string.

```typescript
function getDropZoneType(zoneId: string): DropZoneType  // 'before' | 'after' | 'into'
```

#### generateId

**Core.** Generate a unique ID (timestamp + random).

```typescript
function generateId(): string
```

#### triggerHaptic

**React.** Trigger device vibration. No-ops if the vibration API is unavailable.

```typescript
function triggerHaptic(durationMs?: number): void  // Default: 10ms
```

#### debounce

**Core.** Create a debounced function with a `cancel()` method.

```typescript
function debounce<Args extends unknown[]>(
  fn: (...args: Args) => void,
  delay: number
): ((...args: Args) => void) & { cancel: () => void }
```

### Collision Detection Bridge

#### adaptCollisionDetection

**React.** Bridges a core `CoreCollisionDetection` function to @dnd-kit's `CollisionDetection` type. Useful when writing custom collision detectors with the framework-agnostic core API and using them in `<BlockTree>`.

```typescript
function adaptCollisionDetection(
  coreDetector: CoreCollisionDetection
): CollisionDetection
```

See [Collision Detection](/docs/collision-detection) for details on built-in algorithms and the core vs dnd-kit type distinction.

### Serialization

**Core** exports. See [Serialization](/docs/serialization) for details.

```typescript
function flatToNested<T extends BaseBlock>(blocks: T[]): NestedBlock<T>[]
function nestedToFlat<T extends BaseBlock>(nested: NestedBlock<T>[]): T[]
```

### Merge

**Core** export. Merge two concurrent versions of a block array where each version owns different fields. See [Deferred Sync](/docs/deferred-sync) for full usage details.

```typescript
function mergeBlockVersions<T extends BaseBlock>(
  content: T[],      // owns content fields (title, etc.)
  structure: T[],    // owns structural fields + determines membership
  options?: MergeBlockVersionsOptions
): T[]
```

`structure` determines array membership and ordering. Default structural fields: `['parentId', 'order']`. Customizable via `options.structuralFields`.

### Fractional Indexing

**Core** exports. See [Fractional Indexing](/docs/fractional-indexing) for details.

```typescript
function generateKeyBetween(lo: string | null, hi: string | null): string
function generateNKeysBetween(lo: string | null, hi: string | null, n: number): string[]
function generateInitialKeys(n: number): string[]
function initFractionalOrder<T>(blocks: T[]): T[]
function compareFractionalKeys(a: string, b: string): number
```

### Collision Detection

**Core** exports. See [Collision Detection](/docs/collision-detection) for details.

```typescript
const weightedVerticalCollision: CoreCollisionDetection
const closestCenterCollision: CoreCollisionDetection
function createStickyCollision(
  threshold?: number,
  snapshotRef?: SnapshotRectsRef
): CoreCollisionDetection & { reset: () => void }
```

### Hooks

**React** exports. See individual feature pages for detailed usage.

```typescript
function useBlockHistory<T>(initial: T[], options?): UseBlockHistoryResult<T>
function useLayoutAnimation(ref, options?): void
function useVirtualTree(options): UseVirtualTreeResult
function useConfiguredSensors(config?: SensorConfig): Sensor[]
function getSensorConfig(config?: SensorConfig): { pointer: {...}; touch: {...} }
```

### Context Factories

**React** exports. Factory functions for creating typed block and tree state contexts. Used internally by `BlockTree` but exported for advanced use cases (e.g. custom tree implementations).

```typescript
function createBlockState<T extends BaseBlock>(): {
  useBlockState: () => BlockStateContextValue<T>
  BlockStateProvider: (props: BlockStateProviderProps<T>) => ReactNode
}

function createTreeState<T extends BaseBlock>(options?: {
  previewDebounce?: number
  containerTypes?: readonly string[]
}): {
  useTreeState: () => TreeStateContextValue<T>
  TreeStateProvider: (props: TreeStateProviderProps<T>) => ReactNode
}
```
